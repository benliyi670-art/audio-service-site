<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专业配音服务 - 低预算出好配音</title>
    <style>
        /* 原style部分不变，省略 */
    </style>
</head>
<body>
    <!-- 原HTML结构不变，省略 -->
    <audio id="audioPlayer" preload="auto" crossorigin="anonymous"></audio>

    <script>
        let teachersData = [];
        let currentCategory = 'all';
        let currentSearchTerm = '';
        let currentPage = 1;
        let currentSearchPage = 1;
        const pageSize = 10; // 每页老师数
        const searchPageSize = 5; // 搜索时每页5个音频卡片
        const audioPageSize = 3; // 每个老师音频每页3个
        let audioPages = {}; // 存储每个老师的音频当前页
        let matchingAudios = []; // 存储搜索匹配的音频

        const audioPlayer = document.getElementById('audioPlayer');
        const playerBar = document.getElementById('playerBar');
        const playerTitle = document.getElementById('playerTitle');
        const playerTeacher = document.getElementById('playerTeacher');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const timeDisplay = document.getElementById('timeDisplay');
        const closePlayer = document.getElementById('closePlayer');
        const pagination = document.getElementById('pagination');
        const prevPage = document.getElementById('prevPage');
        const nextPage = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');

        async function init() {
            await loadData();
            renderTeachers();
            setupEventListeners();
            setupPlayer();
        }

        async function loadData() {
            try {
                const response = await fetch('/audios.json');
                if (!response.ok) throw new Error('Failed to load audios.json');
                const json = await response.json();
                teachersData = [];
                for (const catName in json.categories) {
                    const cat = json.categories[catName];
                    cat.teachers.forEach(teacher => {
                        teacher.category = catName;
                        teacher.description = teacher.description || '';
                        teacher.audios.forEach(audio => {
                            audio.duration = 'N/A';
                        });
                        teachersData.push(teacher);
                    });
                }
            } catch (error) {
                console.error('加载数据失败:', error);
            }
        }

        function renderTeachers() {
            const grid = document.getElementById('teachersGrid');
            const noResults = document.getElementById('noResults');
            
            let filteredTeachers = teachersData.filter(t => currentCategory === 'all' || t.category === currentCategory);

            if (currentSearchTerm) {
                matchingAudios = [];
                teachersData.forEach(teacher => {  // 修改为全局teachersData搜索
                    teacher.audios.forEach((audio, index) => {
                        if (audio.title.toLowerCase().includes(currentSearchTerm.toLowerCase()) ||
                            audio.filename.toLowerCase().includes(currentSearchTerm.toLowerCase())) {
                            matchingAudios.push({ teacher, audio, index });
                        }
                    });
                });

                if (matchingAudios.length === 0) {
                    grid.style.display = 'none';
                    noResults.style.display = 'block';
                    pagination.style.display = 'none';
                    return;
                }

                // 随机排序整个列表
                matchingAudios.sort(() => Math.random() - 0.5);

                // 分页展示
                const totalSearchPages = Math.ceil(matchingAudios.length / searchPageSize);
                const searchStart = (currentSearchPage - 1) * searchPageSize;
                const paginatedMatching = matchingAudios.slice(searchStart, searchStart + searchPageSize);

                grid.innerHTML = paginatedMatching.map(({ teacher, audio, index }) => `
                    <div class="teacher-card">
                        <div class="teacher-header">
                            <div class="teacher-avatar">${teacher.id}</div>
                            <div class="teacher-info">
                                <h3>${teacher.name}</h3>
                                <span class="teacher-category">${teacher.category}</span>
                            </div>
                        </div>
                        <div class="teacher-desc">${teacher.description}</div>
                        <div class="audios-list">
                            <div class="audio-item">
                                <button class="play-btn" data-teacher-id="${teacher.id}" data-audio-index="${index}">▶</button>
                                <span class="audio-title">${audio.title}</span>
                                <span class="audio-duration">${audio.duration}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                grid.querySelectorAll('.play-btn').forEach(btn => btn.addEventListener('click', handlePlayClick));

                grid.style.display = 'grid';
                noResults.style.display = 'none';

                // 更新搜索分页
                pageInfo.textContent = `${currentSearchPage} / ${totalSearchPages}`;
                prevPage.disabled = currentSearchPage === 1;
                nextPage.disabled = currentSearchPage === totalSearchPages;
                pagination.style.display = 'flex';
            } else {
                if (filteredTeachers.length === 0) {
                    grid.style.display = 'none';
                    noResults.style.display = 'block';
                    pagination.style.display = 'none';
                    return;
                }

                // 分页
                const totalPages = Math.ceil(filteredTeachers.length / pageSize);
                const start = (currentPage - 1) * pageSize;
                const paginatedTeachers = filteredTeachers.slice(start, start + pageSize);

                grid.innerHTML = paginatedTeachers.map(teacher => `
                    <div class="teacher-card" data-teacher-id="${teacher.id}">
                        <div class="teacher-header">
                            <div class="teacher-avatar">${teacher.id}</div>
                            <div class="teacher-info">
                                <h3>${teacher.name}</h3>
                                <span class="teacher-category">${teacher.category}</span>
                            </div>
                        </div>
                        <div class="teacher-desc">${teacher.description}</div>
                        <div class="audios-list" id="audios-${teacher.id}"></div>
                        <div class="audio-pagination" id="audio-pagination-${teacher.id}"></div>
                    </div>
                `).join('');

                paginatedTeachers.forEach(teacher => renderAudios(teacher.id));

                grid.style.display = 'grid';
                noResults.style.display = 'none';

                // 更新分页
                pageInfo.textContent = `${currentPage} / ${totalPages}`;
                prevPage.disabled = currentPage === 1;
                nextPage.disabled = currentPage === totalPages;
                pagination.style.display = 'flex';
            }
        }

        function renderAudios(teacherId) {
            const teacher = teachersData.find(t => t.id === teacherId);
            const audiosList = document.getElementById(`audios-${teacherId}`);
            const audioPagination = document.getElementById(`audio-pagination-${teacherId}`);
            const page = audioPages[teacherId] || 1;
            const totalAudioPages = Math.ceil(teacher.audios.length / audioPageSize);
            const start = (page - 1) * audioPageSize;
            const paginatedAudios = teacher.audios.slice(start, start + audioPageSize);

            audiosList.innerHTML = paginatedAudios.map((audio, index) => `
                <div class="audio-item">
                    <button class="play-btn" data-teacher-id="${teacher.id}" data-audio-index="${start + index}">▶</button>
                    <span class="audio-title">${audio.title}</span>
                    <span class="audio-duration">${audio.duration}</span>
                </div>
            `).join('');

            audioPagination.innerHTML = `
                <button class="audio-page-btn" ${page === 1 ? 'disabled' : ''} onclick="changeAudioPage('${teacherId}', -1)">上一页</button>
                <span>${page} / ${totalAudioPages}</span>
                <button class="audio-page-btn" ${page === totalAudioPages ? 'disabled' : ''} onclick="changeAudioPage('${teacherId}', 1)">下一页</button>
            `;

            audiosList.querySelectorAll('.play-btn').forEach(btn => btn.addEventListener('click', handlePlayClick));
        }

        function changeAudioPage(teacherId, delta) {
            const current = audioPages[teacherId] || 1;
            audioPages[teacherId] = Math.max(1, current + delta);
            renderAudios(teacherId);
        }

        function handlePlayClick(e) {
            const teacherId = e.target.dataset.teacherId;
            const audioIndex = parseInt(e.target.dataset.audioIndex);
            playAudio(teacherId, audioIndex);
        }

        function playAudio(teacherId, audioIndex) {
            const teacher = teachersData.find(t => t.id === teacherId);
            const audio = teacher.audios[audioIndex];
            
            audioPlayer.src = audio.url + '?t=' + new Date().getTime(); // 添加时间戳防缓存
            audioPlayer.load(); // 强制加载
            const playPromise = audioPlayer.play();
            if (playPromise !== undefined) {
                playPromise.catch(error => {
                    console.error('播放失败:', error, 'URL:', audio.url);
                });
            }
            playerTitle.textContent = audio.title;
            playerTeacher.textContent = `${teacher.name} - ${teacher.category}`;
            playerBar.classList.add('active');
            playPauseBtn.textContent = '⏸';
            
            // 更新时长
            audioPlayer.addEventListener('loadedmetadata', () => {
                audio.duration = formatTime(audioPlayer.duration);
                const durationSpan = document.querySelector(`[data-teacher-id="${teacherId}"][data-audio-index="${audioIndex}"] + .audio-title + .audio-duration`);
                if (durationSpan) durationSpan.textContent = audio.duration;
            }, { once: true });

            // 错误监听
            audioPlayer.addEventListener('error', (e) => {
                console.error('音频错误:', e.message, 'URL:', audio.url);
            }, { once: true });
        }

        function setupPlayer() {
            audioPlayer.addEventListener('timeupdate', () => {
                const progress = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                progressFill.style.width = `${progress}%`;
                timeDisplay.textContent = `${formatTime(audioPlayer.currentTime)} / ${formatTime(audioPlayer.duration)}`;
            });

            audioPlayer.addEventListener('ended', () => {
                playPauseBtn.textContent = '▶';
            });

            playPauseBtn.addEventListener('click', () => {
                if (audioPlayer.paused) {
                    audioPlayer.play();
                    playPauseBtn.textContent = '⏸';
                } else {
                    audioPlayer.pause();
                    playPauseBtn.textContent = '▶';
                }
            });

            progressBar.addEventListener('click', (e) => {
                const rect = progressBar.getBoundingClientRect();
                const offsetX = e.clientX - rect.left;
                audioPlayer.currentTime = (offsetX / rect.width) * audioPlayer.duration;
            });

            closePlayer.addEventListener('click', () => {
                playerBar.classList.remove('active');
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
            });
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', (e) => {
                currentSearchTerm = e.target.value.trim();
                currentSearchPage = 1;
                renderTeachers();
            });

            document.getElementById('searchBtn').addEventListener('click', () => {
                currentSearchTerm = document.getElementById('searchInput').value.trim();
                currentSearchPage = 1;
                renderTeachers();
            });

            document.getElementById('searchInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    currentSearchTerm = e.target.value.trim();
                    currentSearchPage = 1;
                    renderTeachers();
                }
            });

            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentCategory = btn.dataset.category;
                    currentPage = 1;
                    renderTeachers();
                });
            });

            prevPage.addEventListener('click', () => {
                if (currentSearchTerm) {
                    if (currentSearchPage > 1) {
                        currentSearchPage--;
                        renderTeachers();
                    }
                } else {
                    if (currentPage > 1) {
                        currentPage--;
                        renderTeachers();
                    }
                }
            });

            nextPage.addEventListener('click', () => {
                if (currentSearchTerm) {
                    currentSearchPage++;
                    renderTeachers();
                } else {
                    currentPage++;
                    renderTeachers();
                }
            });
        }

        window.changeAudioPage = changeAudioPage;

        init();
    </script>
</body>
</html>